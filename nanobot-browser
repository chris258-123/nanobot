#!/usr/bin/env python3
"""
Nanobot Browser Tool - å‘½ä»¤è¡Œå·¥å…·
ç›´æ¥è°ƒç”¨æµè§ˆå™¨è¿›è¡Œè‡ªåŠ¨åŒ–æ“ä½œ
"""

import asyncio
import sys
from pathlib import Path

# æ·»åŠ  nanobot åˆ° Python è·¯å¾„
sys.path.insert(0, str(Path.home() / 'Desktop/my_workspace/nanobot'))

from nanobot.agent.tools.browser import BrowserTool


async def cmd_open(url):
    """æ‰“å¼€ç½‘é¡µ"""
    tool = BrowserTool()
    print(f"ğŸŒ æ‰“å¼€ {url}...")
    result = await tool.execute(action="open", target=url)
    print(result)
    print("\nğŸ’¡ æç¤º: æµè§ˆå™¨ä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œä½¿ç”¨å…¶ä»–å‘½ä»¤ç»§ç»­æ“ä½œ")


async def cmd_screenshot(url, filename="screenshot.png"):
    """æ‰“å¼€ç½‘é¡µå¹¶æˆªå›¾"""
    tool = BrowserTool()

    print(f"ğŸŒ æ‰“å¼€ {url}...")
    await tool.execute(action="open", target=url)

    print("â³ ç­‰å¾…é¡µé¢åŠ è½½...")
    await asyncio.sleep(3)

    print(f"ğŸ“¸ æˆªå›¾ä¿å­˜åˆ° {filename}...")
    result = await tool.execute(action="screenshot", target=filename)
    print(result)

    print("ğŸ”’ å…³é—­æµè§ˆå™¨...")
    await tool.execute(action="close")

    print(f"\nâœ… å®Œæˆï¼æˆªå›¾å·²ä¿å­˜åˆ°: {filename}")


async def cmd_snapshot(url):
    """è·å–é¡µé¢ç»“æ„å’Œå…ƒç´ å¼•ç”¨"""
    tool = BrowserTool()

    print(f"ğŸŒ æ‰“å¼€ {url}...")
    await tool.execute(action="open", target=url)

    print("â³ ç­‰å¾…é¡µé¢åŠ è½½...")
    await asyncio.sleep(2)

    print("ğŸ“‹ è·å–é¡µé¢å¿«ç…§...")
    result = await tool.execute(action="snapshot")
    print("\n" + "="*60)
    print(result)
    print("="*60)

    print("\nğŸ”’ å…³é—­æµè§ˆå™¨...")
    await tool.execute(action="close")


async def cmd_search_github(keyword):
    """åœ¨ GitHub ä¸Šæœç´¢å¹¶æˆªå›¾"""
    tool = BrowserTool()
    url = f"https://github.com/search?q={keyword}"

    print(f"ğŸ” åœ¨ GitHub æœç´¢: {keyword}")
    await tool.execute(action="open", target=url)

    print("â³ ç­‰å¾…æœç´¢ç»“æœ...")
    await asyncio.sleep(3)

    filename = f"github-search-{keyword}.png"
    print(f"ğŸ“¸ æˆªå›¾ä¿å­˜åˆ° {filename}...")
    await tool.execute(action="screenshot", target=filename)

    print("ğŸ“‹ è·å–æœç´¢ç»“æœ...")
    snapshot = await tool.execute(action="snapshot")
    print("\næœç´¢ç»“æœé¢„è§ˆ:")
    print(snapshot[:500] + "...")

    print("\nğŸ”’ å…³é—­æµè§ˆå™¨...")
    await tool.execute(action="close")

    print(f"\nâœ… å®Œæˆï¼æˆªå›¾å·²ä¿å­˜åˆ°: {filename}")


async def cmd_close():
    """å…³é—­æµè§ˆå™¨"""
    tool = BrowserTool()
    print("ğŸ”’ å…³é—­æµè§ˆå™¨...")
    result = await tool.execute(action="close")
    print(result)


def print_usage():
    """æ‰“å°ä½¿ç”¨è¯´æ˜"""
    print("""
Nanobot Browser Tool - æµè§ˆå™¨è‡ªåŠ¨åŒ–å·¥å…·

ç”¨æ³•:
    nanobot-browser <command> [arguments]

å‘½ä»¤:
    open <url>                  æ‰“å¼€ç½‘é¡µ
    screenshot <url> [file]     æ‰“å¼€ç½‘é¡µå¹¶æˆªå›¾
    snapshot <url>              è·å–é¡µé¢ç»“æ„å’Œå…ƒç´ å¼•ç”¨
    search-github <keyword>     åœ¨ GitHub æœç´¢å¹¶æˆªå›¾
    close                       å…³é—­æµè§ˆå™¨

ç¤ºä¾‹:
    nanobot-browser open https://github.com
    nanobot-browser screenshot https://github.com github.png
    nanobot-browser snapshot https://example.com
    nanobot-browser search-github nanobot
    nanobot-browser close

æç¤º:
    - æˆªå›¾é»˜è®¤ä¿å­˜ä¸º screenshot.png
    - ä½¿ç”¨ snapshot è·å–å…ƒç´ å¼•ç”¨ (@e1, @e2, ...)
    - æµè§ˆå™¨ä¼šåœ¨æ“ä½œå®Œæˆåè‡ªåŠ¨å…³é—­ï¼ˆé™¤äº† open å‘½ä»¤ï¼‰
""")


async def main():
    if len(sys.argv) < 2:
        print_usage()
        sys.exit(1)

    command = sys.argv[1]

    try:
        if command == "open":
            if len(sys.argv) < 3:
                print("âŒ é”™è¯¯: éœ€è¦æä¾› URL")
                print("ç”¨æ³•: nanobot-browser open <url>")
                sys.exit(1)
            await cmd_open(sys.argv[2])

        elif command == "screenshot":
            if len(sys.argv) < 3:
                print("âŒ é”™è¯¯: éœ€è¦æä¾› URL")
                print("ç”¨æ³•: nanobot-browser screenshot <url> [filename]")
                sys.exit(1)
            url = sys.argv[2]
            filename = sys.argv[3] if len(sys.argv) > 3 else "screenshot.png"
            await cmd_screenshot(url, filename)

        elif command == "snapshot":
            if len(sys.argv) < 3:
                print("âŒ é”™è¯¯: éœ€è¦æä¾› URL")
                print("ç”¨æ³•: nanobot-browser snapshot <url>")
                sys.exit(1)
            await cmd_snapshot(sys.argv[2])

        elif command == "search-github":
            if len(sys.argv) < 3:
                print("âŒ é”™è¯¯: éœ€è¦æä¾›æœç´¢å…³é”®è¯")
                print("ç”¨æ³•: nanobot-browser search-github <keyword>")
                sys.exit(1)
            await cmd_search_github(sys.argv[2])

        elif command == "close":
            await cmd_close()

        elif command in ["-h", "--help", "help"]:
            print_usage()

        else:
            print(f"âŒ æœªçŸ¥å‘½ä»¤: {command}")
            print_usage()
            sys.exit(1)

    except Exception as e:
        print(f"\nâŒ é”™è¯¯: {e}")
        sys.exit(1)


if __name__ == "__main__":
    asyncio.run(main())
